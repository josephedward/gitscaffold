#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: $(basename "$0") [-n COUNT] [-i INTERVAL] -- [codex args…]"
  echo "  -n COUNT     number of times to run (default: infinite)"
  echo "  -i INTERVAL  secs between runs (default: 20)"
  echo "  [codex args] everything after “--” is passed straight to codex"
  exit 1
}

COUNT=0
INTERVAL=20

while getopts ":n:i:" opt; do
  case $opt in
    n) COUNT=$OPTARG ;;
    i) INTERVAL=$OPTARG ;;
    *) usage ;;
  esac
done
shift $((OPTIND-1))

[[ $# -gt 0 ]] || usage

runs=0
while [[ $COUNT -eq 0 || $runs -lt $COUNT ]]; do
  codex "$@"
  runs=$((runs+1))
  if [[ $COUNT -ne 0 && $runs -ge $COUNT ]]; then
    break
  fi
  sleep "$INTERVAL"
done
