# Gitscaffold — Working Plan and Shared Context (2025-10-04)

This document coordinates the CLI streamlining and release prep across two agents:
- Agent A (you are here): CLI restructure, command grouping, migration scaffolding, docs.
- Agent B: Tests, deduplication, and architecture hardening for a clean release.

## Goals
- Introduce clear, modular CLI groups: `settings`, `roadmap`, `issues`, `ci`, `source`, `api`, `demo`, `ai`.
- Sequester commands by maturity: Working, In‑Progress, Not Implemented.
- Maintain backward compatibility during transition (aliases + deprecation warnings).
- Keep the UX coherent and self‑documenting with `--help` and examples.

## Proposed CLI Groups and Status

- settings
  - install/uninstall: Working (uninstall exists; install for scripts exists; align wording)
  - show/get/list/path/set/remove: Working (in current `config` group)
  - setup: Working (exists as `setup`)
- roadmap
  - sync: Working
  - diff: Working
  - import-md: Working (AI extraction)
  - export: Not Implemented (placeholder)
- issues
  - list: Working (currently under `gh issue-list`)
  - delete-closed: Working
  - deduplicate: Working
  - sanitize: Working
  - enrich: Working (group exists: `enrich issue|batch`)
  - next: Working (suggests next action item)
  - match: Working (PR-to-issue matching)
- ci
  - run-local: Working (`run-action-locally`)
  - list/status: In‑Progress (no dedicated commands yet; investigate `gh` usage)
- source
  - delete-branches: Working (currently `ops delete-branches`)
  - remove-from-git: Working (currently `ops remove-from-git`)
  - repo maintenance (aggregate/archive/delete repos): Working but consider scoping (currently under `ops`)
- api
  - start: Working (`start-api`)
  - stop/status: Not Implemented (placeholders)
- demo
  - streamlit: Working (`start-demo`)
  - examples: Not Implemented (placeholder)
- ai
  - aider (assistant): Working (`assistant` group; includes `process-issues`)
  - vibe: In‑Progress (push implemented, pull is stubbed in `vibe_kanban.py`)
  - enrich: Working (as above under `issues/enrich` mapping)

Notes
- Current monolith is `scaffold/cli.py` with multiple overlapping groups (`config`, `gh`, `scripts`, `ops`, `vibe`, `assistant`, etc.). Several commands appear duplicated; dedup during refactor.
- Vibe Kanban `pull` raises NotImplementedError; `push` makes a live HTTP request and may fail if service isn’t running.

## Backward Compatibility Plan
- Keep legacy entry points (`config`, `gh`, `scripts`, `ops`, `start-demo`, `start-api`, `assistant`, `run-action-locally`) as thin wrappers for one release cycle.
- Print one‑line deprecation notices pointing to the new path, e.g., "Deprecated: use `gitscaffold source delete-branches`".
- Add `cli --help` top section explaining the new organization and migration notes.

## Migration Steps (High Level)
1) Create modular files and groups
   - `gitscaffold/cli.py` (root group + registration only)
   - `gitscaffold/settings.py`, `roadmap.py`, `issues.py`, `ci.py`, `source.py`, `api.py`, `demo.py`, `ai.py`
2) Move commands, keep wrappers
   - Rehome implementations into new modules; keep wrappers in the monolith that call through and warn.
3) Normalize option names and help text
   - Consistent `--repo owner/name`, `--dry-run`, `--yes`, `--token`, `--ai-provider`, etc.
4) Document examples
   - Update README command examples to new paths; keep a “legacy commands” note.
5) Remove wrappers after one stable release
   - Delete legacy groups; prune dead code.

## Test & Release Checklist (Agent B lead)
- CLI help tree
  - `gitscaffold --help` shows only new groups at top level.
  - Each group `--help` lists commands with clear 1‑line purpose.
- Command smoke tests
  - `settings set/get/list/path/remove`
  - `roadmap sync/diff/import-md` (mock API for AI + GitHub)
  - `issues list/delete-closed/deduplicate/sanitize/enrich/next/match` (mock GitHub)
  - `ci run-local` (act invocation mocked); plan for `list/status` once implemented
  - `source delete-branches/remove-from-git` (dry‑run; no destructive operations in CI)
  - `api start` (spawn subprocess mocked)
  - `demo streamlit` (skip on CI; verify command wiring only)
  - `ai aider` and `ai vibe push/pull` (mock HTTP for vibe; mark pull as xfail until implemented)
- Regression
  - Verify wrappers resolve to the new paths and print deprecation.
- Style/duplication
  - Remove duplicated command blocks in `scaffold/cli.py` during migration.

## Open Questions
- Should repo‑wide maintenance scripts (`aggregate/archive/delete repos`) stay under `source` or be an advanced `maintenance` subgroup?
- Do we want `issues enrich` folded under `ai enrich` for clarity, or keep under `issues` with `ai` as a provider option?
- How strict should we be with interactive prompts vs `--yes` defaults for automation?

## Short‑Term Tasks (Agent A)
- Scaffold the new groups/modules and register them from `cli.py`.
- Implement `source` commands by calling existing script runners.
- Add `settings uninstall` that reuses existing uninstall logic; move `config` subcommands under `settings`.
- Wrap old groups with deprecation messages pointing to the new layout.

## Short‑Term Tasks (Agent B)
- Add CLI snapshot tests (help text and exit codes) for new groups.
- Mock external systems (GitHub, OpenAI/Gemini, Vibe, `act`, `uvicorn`).
- Deduplicate repeated command blocks in current `scaffold/cli.py`.
- Extract shared helpers (token loading, repo detection, printing) to a small `utils.py`.

## Usage Examples (New Layout)

Settings & Configuration
- `gitscaffold settings uninstall`
- `gitscaffold settings show` (alias for `list`/`path` where suitable)
- `gitscaffold settings set --token xyz`

Roadmap
- `gitscaffold roadmap sync docs/ROADMAP.md --repo owner/repo`
- `gitscaffold roadmap diff docs/ROADMAP.md --repo owner/repo`
- `gitscaffold roadmap import-md docs/brainstorm.md --repo owner/repo`

Issues
- `gitscaffold issues list --repo owner/repo`
- `gitscaffold issues delete-closed --repo owner/repo`
- `gitscaffold issues deduplicate --repo owner/repo`
- `gitscaffold issues sanitize --repo owner/repo`
- `gitscaffold issues enrich --repo owner/repo`

CI
- `gitscaffold ci run-local --workflow-file .github/workflows/ci.yml`
- `gitscaffold ci list` (TBD)
- `gitscaffold ci status` (TBD)

Source
- `gitscaffold source delete-branches --repo owner/repo`
- `gitscaffold source remove-from-git path/to/file`

API
- `gitscaffold api start`
- `gitscaffold api status` (TBD)

Demo
- `gitscaffold demo streamlit`
- `gitscaffold demo examples` (TBD)

AI
- `gitscaffold ai aider`
- `gitscaffold ai vibe push --repo owner/repo --board Team`
- `gitscaffold ai vibe pull --repo owner/repo --board Team` (TBD)
- `gitscaffold ai enrich --repo owner/repo`

## Notes for Implementation
- Preserve env loading order and token helpers; move to a shared module.
- Ensure `--repo` detection fallback remains (via git config) with consistent messaging.
- Keep destructive commands gated behind explicit prompts or `--yes`.
- Add `--dry-run` wherever feasible.

## Next Milestone (cutover plan)
- 0.9.x: Introduce new groups + wrappers, update docs, publish deprecation.
- 1.0.0: Remove wrappers and legacy groups, finalize help output.

